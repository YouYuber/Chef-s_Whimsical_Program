<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>管理画面 - 動画追加</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>動画管理</h1>
  <div style="margin-left:auto;padding-right:20px;"><a class="link" href="index.html">一覧へ戻る</a></div>
</header>

<div class="admin-wrap">
  <div style="margin-bottom:12px;color:#555;"><strong>使い方：</strong>下のフォームで新しい動画を追加→「JSONダウンロード」で videos.json を保存→ GitHub リポジトリにアップロードしてください。</div>

  <div class="field">
    <input id="title" placeholder="タイトル">
    <input id="driveId" class="small" placeholder="GoogleDriveファイルID">
  </div>
  <div class="field">
    <textarea id="desc" placeholder="説明" rows="2"></textarea>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:18px;">
    <button id="addBtn" class="btn">追加</button>
    <button id="downloadBtn" class="btn" style="background:#28a745">JSONダウンロード</button>
    <button id="copyBtn" class="btn" style="background:#0077b6">JSONをコピー</button>
    <button id="clearBtn" class="btn" style="background:#999">全クリア</button>
  </div>

  <div id="listArea"></div>
</div>

<script>
/* ========== 同期するSECRET/PW - index.html と合わせること ========== */
const SITE_PASSWORD = "yourStrongPassword123";   // ← index.html と合わせる
const SITE_SECRET_KEY = "mySecretKey2025";       // ← index.html と合わせる

/* ========== 簡易保護 ========== */
if (localStorage.getItem("site_pw_ok") !== "1") {
  const res = prompt("管理用パスワードを入力してください");
  if (res !== SITE_PASSWORD) {
    alert("パスワードが違います。管理画面を閉じます。");
    location.href = "index.html";
  } else {
    localStorage.setItem("site_pw_ok","1");
  }
}

/* ========== 動画リストの保持（ブラウザ内） ========== */
let videos = [];
async function loadRemote(){
  try {
    const r = await fetch("videos.json");
    videos = await r.json();
  } catch(e){
    videos = [];
  }
  renderList();
}
function renderList(){
  const area = document.getElementById("listArea");
  if (!videos.length) {
    area.innerHTML = "<div style='color:#666;padding:12px;border-radius:8px;background:#fff'>動画がありません</div>";
    return;
  }
  area.innerHTML = videos.map(v => `
    <div style="display:flex;gap:8px;align-items:center;padding:8px;background:#fff;margin-bottom:8px;border-radius:8px;">
      <div style="width:64px;height:36px;background:#eee;border-radius:6px;overflow:hidden;">
        <img src="https://drive.google.com/thumbnail?id=${v.driveId}" style="width:100%;height:100%;object-fit:cover;">
      </div>
      <div style="flex:1;">
        <div style="font-weight:600">${escapeHtml(v.title)}</div>
        <div style="color:#666;font-size:13px">${escapeHtml(v.description)}</div>
      </div>
      <div style="display:flex;gap:6px;">
        <button onclick="editItem('${v.id}')" class="btn" style="background:#ffb703">編集</button>
        <button onclick="deleteItem('${v.id}')" class="btn" style="background:#e63946">削除</button>
      </div>
    </div>
  `).join("");
}

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function genId(){
  return 'v' + Math.random().toString(36).slice(2,10);
}

document.getElementById("addBtn").onclick = () => {
  const title = document.getElementById("title").value.trim();
  const driveId = document.getElementById("driveId").value.trim();
  const desc = document.getElementById("desc").value.trim();
  if (!title || !driveId) { alert("タイトルとDriveファイルIDは必須です"); return; }
  const item = { id: genId(), title, description: desc, driveId };
  videos.unshift(item);
  renderList();
  document.getElementById("title").value = "";
  document.getElementById("driveId").value = "";
  document.getElementById("desc").value = "";
};

/* 編集・削除 */
function editItem(id){
  const it = videos.find(v=>v.id===id);
  if(!it) return;
  const nt = prompt("新しいタイトルを入力", it.title);
  if (nt === null) return;
  it.title = nt;
  renderList();
}
function deleteItem(id){
  if (!confirm("削除してよいですか？")) return;
  videos = videos.filter(v=>v.id!==id);
  renderList();
}

/* ダウンロード（videos.jsonを生成） */
document.getElementById("downloadBtn").onclick = () => {
  const blob = new Blob([JSON.stringify(videos, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "videos.json";
  a.click();
  URL.revokeObjectURL(url);
};

/* クリップボードコピー */
document.getElementById("copyBtn").onclick = async () => {
  try {
    await navigator.clipboard.writeText(JSON.stringify(videos, null, 2));
    alert("JSONをクリップボードにコピーしました。");
  } catch(e){ alert("コピーに失敗しました。ブラウザが対応していない可能性があります。"); }
};

document.getElementById("clearBtn").onclick = () => {
  if (!confirm("本当に全てクリアしますか？")) return;
  videos = [];
  renderList();
};

/* 初期ロード */
loadRemote();
</script>

</body>
</html>
